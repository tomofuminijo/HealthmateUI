# 実装計画

- [x] 1. 開発環境のセットアップ
  - Python 3.12仮想環境の作成と依存関係のインストール
  - 開発用ディレクトリ構造の作成
  - 既存リソース情報の設定ファイル作成（Cognito、HealthCoachAI等）
  - 基本的な設定ファイルの準備
  - _要件: 5.4_
  - _既存リソース: UserPoolId=us-west-2_H5DVWxi8O, ClientId=75skorj1n3i072ope5vut43h92, AgentRuntimeId=health_coach_ai-87qw32GDCf_

- [ ] 2. FastAPI バックエンドの基盤実装
- [x] 2.1 FastAPIアプリケーションの基本構造を作成
  - main.pyとアプリケーション初期化
  - 基本的なルーティング設定
  - 設定管理とログ設定の実装
  - _要件: 5.5_

- [ ]* 2.2 プロパティテスト: HTTPリクエスト処理
  - **プロパティ 16: HTTPリクエストの処理**
  - **検証対象: 要件 5.5**

- [x] 2.3 Cognito認証モジュールの実装
  - OAuth 2.0認証フローの実装
  - JWTトークン検証機能
  - セッション管理機能
  - _要件: 1.2, 1.3, 1.4, 1.5_

- [ ]* 2.4 プロパティテスト: 認証処理
  - **プロパティ 1: 有効認証情報による認証成功**
  - **検証対象: 要件 1.2**

- [ ]* 2.5 プロパティテスト: 認証成功時のリダイレクト
  - **プロパティ 2: 認証成功時のリダイレクト**
  - **検証対象: 要件 1.3**

- [ ]* 2.6 プロパティテスト: 認証失敗時のエラー処理
  - **プロパティ 3: 認証失敗時のエラー処理**
  - **検証対象: 要件 1.4**

- [ ]* 2.7 プロパティテスト: セッション期限切れ処理
  - **プロパティ 4: セッション期限切れ時のリダイレクト**
  - **検証対象: 要件 1.5**

- [ ] 3. HealthCoachAI連携機能の実装
- [x] 3.1 Bedrock AgentCore Runtime連携モジュールを実装
  - AgentCore CLI (`agentcore invoke`) を使用したHealthCoachAI連携
  - JWTトークン、タイムゾーン、言語をペイロードに含める実装
  - ストリーミング対応（JSON形式のイベントストリーム処理）
  - エラーハンドリング機能
  - _要件: 3.1, 3.2, 3.3, 3.4_
  - _参考実装: HealthCoachAI/manual_test_deployed_agent.py_
  - _既存リソース: AgentRuntimeId=health_coach_ai-87qw32GDCf_

- [ ]* 3.2 プロパティテスト: JWTトークン転送
  - **プロパティ 9: JWTトークン転送の保証**
  - **検証対象: 要件 3.1**

- [ ]* 3.3 プロパティテスト: 無効トークン処理
  - **プロパティ 10: 無効トークンのエラー処理**
  - **検証対象: 要件 3.2**

- [ ]* 3.4 プロパティテスト: トークンリフレッシュ
  - **プロパティ 11: トークンリフレッシュの実行**
  - **検証対象: 要件 3.3**

- [ ]* 3.5 プロパティテスト: リフレッシュ失敗処理
  - **プロパティ 12: リフレッシュ失敗時のエラー返却**
  - **検証対象: 要件 3.4**

- [ ] 4. チャット機能の実装
- [x] 4.1 チャットメッセージ処理機能を実装
  - メッセージ送信API
  - チャット履歴取得API
  - メッセージ検証とサニタイゼーション
  - _要件: 2.1, 4.2, 4.4_

- [ ]* 4.2 プロパティテスト: メッセージ送信
  - **プロパティ 5: メッセージ送信の完全性**
  - **検証対象: 要件 2.1**

- [ ]* 4.3 プロパティテスト: チャット履歴表示
  - **プロパティ 13: チャット履歴の時系列表示**
  - **検証対象: 要件 4.2**

- [ ]* 4.4 プロパティテスト: 新メッセージ追加
  - **プロパティ 14: 新メッセージの履歴追加**
  - **検証対象: 要件 4.4**

- [ ] 5. ストリーミング機能の実装
- [x] 5.1 ストリーミングレスポンス処理を実装
  - Server-Sent Events (SSE) 実装
  - AgentCore CLIからのJSONイベントストリーム処理
  - contentBlockDelta形式のテキストチャンク抽出
  - 接続管理とエラーハンドリング
  - _要件: 2.2, 2.3_
  - _参考実装: manual_test_deployed_agent.pyのストリーミング処理_

- [ ]* 5.2 プロパティテスト: ストリーミング表示
  - **プロパティ 6: ストリーミング応答のリアルタイム表示**
  - **検証対象: 要件 2.2**

- [ ]* 5.3 プロパティテスト: ストリーミング更新
  - **プロパティ 7: ストリーミング時の段階的更新**
  - **検証対象: 要件 2.3**

- [x] 6. チェックポイント - バックエンドテスト実行
  - すべてのテストが通ることを確認し、ユーザに質問があれば尋ねる

- [ ] 7. フロントエンド基盤の実装
- [x] 7.1 静的ファイル構造とHTMLテンプレートを作成
  - ベースHTMLテンプレート
  - ログインページ
  - チャットページ
  - CSS基本スタイル
  - _要件: 1.1, 6.5_

- [x] 7.2 htmx統合とJavaScript機能を実装
  - htmx設定とカスタムJavaScript
  - フォーム処理とAJAX通信
  - UI状態管理
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ]* 7.3 プロパティテスト: htmx部分更新
  - **プロパティ 17: htmx部分更新の限定性**
  - **検証対象: 要件 6.1**

- [ ]* 7.4 プロパティテスト: スクロール位置維持
  - **プロパティ 18: スクロール位置の維持**
  - **検証対象: 要件 6.2**

- [ ]* 7.5 プロパティテスト: 視覚的フィードバック
  - **プロパティ 19: 視覚的フィードバックの提供**
  - **検証対象: 要件 6.3**

- [ ]* 7.6 プロパティテスト: エラー時のフロー維持
  - **プロパティ 20: エラー時のフロー維持**
  - **検証対象: 要件 6.4**

- [x] 7.7 Cognitoログイン機能の実装
  - OAuth 2.0認証フローのUI実装
  - ログインページの機能強化
  - 認証状態管理とリダイレクト処理
  - JWTトークン取得とセッション確立
  - ログアウト機能の実装
  - 認証エラーハンドリングとユーザーフィードバック
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 7.8 プロパティテスト: ログイン機能
  - **プロパティ 1: 有効認証情報による認証成功**
  - **プロパティ 2: 認証成功時のリダイレクト**
  - **プロパティ 3: 認証失敗時のエラー処理**
  - **プロパティ 4: セッション期限切れ時のリダイレクト**
  - **検証対象: 要件 1.2, 1.3, 1.4, 1.5**

- [ ] 8. UI機能の統合実装
- [x] 8.1 メッセージ送信UI機能を実装
  - メッセージ入力フォーム
  - 送信ボタンとキーボードショートカット
  - 入力フィールドのクリアとフォーカス管理
  - _要件: 2.4_

- [ ]* 8.2 プロパティテスト: UI状態管理
  - **プロパティ 8: メッセージ送信後のUI状態管理**
  - **検証対象: 要件 2.4**

- [ ] 8.3 チャット履歴表示UI機能を実装
  - 履歴表示コンポーネント
  - 自動スクロール機能
  - タイムスタンプ表示
  - _要件: 4.1, 4.3_

- [ ] 9. ローカル開発環境の整備
- [ ] 9.1 ローカル開発サーバーを設定
  - FastAPI開発サーバー設定
  - 静的ファイル配信設定
  - ホットリロード機能
  - 開発用環境変数設定

- [ ] 9.2 モック機能を実装
  - HealthCoachAIモック応答（本番: health_coach_ai-87qw32GDCf）
  - Cognitoモック認証（本番: us-west-2_H5DVWxi8O）
  - テストデータ生成機能

- [ ] 10. AWS CDKインフラストラクチャの実装
- [ ] 10.1 CDKスタック基盤を作成
  - CDKプロジェクト初期化
  - Lambda関数定義
  - Function URL設定
  - 環境変数設定
  - _要件: 5.1, 5.2_

- [ ] 10.2 S3とCloudFront設定を実装
  - S3バケット作成
  - CloudFront配信設定
  - 静的ファイルデプロイ設定
  - _要件: 5.3_

- [ ]* 10.3 プロパティテスト: 静的コンテンツ配信
  - **プロパティ 15: 静的コンテンツの配信**
  - **検証対象: 要件 5.3**

- [ ] 11. Docker化とデプロイ準備
- [ ] 11.1 Dockerファイルとコンテナ設定を作成
  - マルチステージDockerfile
  - 依存関係の最適化
  - セキュリティ設定
  - _要件: 5.4_

- [ ] 11.2 デプロイスクリプトを作成
  - ECRプッシュスクリプト
  - CDKデプロイスクリプト
  - 環境別設定管理

- [ ] 12. 統合テストとE2Eテスト
- [ ]* 12.1 統合テストを実装
  - 認証フロー統合テスト
  - チャット機能統合テスト
  - エラーハンドリング統合テスト

- [ ]* 12.2 E2Eテストを実装
  - Playwrightテストスイート
  - ユーザーシナリオテスト
  - レスポンシブデザインテスト

- [ ] 13. AgentCore Memory統合実装
- [ ] 13.1 HealthCoachAI AgentCore Memory設定の確認と修正
  - .bedrock_agentcore.yamlのmemory_id設定確認
  - AgentCoreMemoryConfigの正しい設定
  - メモリ統合のテスト実行
  - _要件: Actor ID = User Sub (長期記憶), Session ID = UI側セッション区切り_

- [ ] 13.2 セッション管理パターンの実装
  - Actor ID: JWT token の `sub` フィールドを使用（ユーザごとの長期記憶）
  - Session ID: UI側で生成されるセッションIDを使用（会話セッション区切り）
  - AgentCoreMemorySessionManagerの適切な設定
  - 既存のセッション管理との統合確認

- [ ] 13.3 メモリ機能のテスト実装
  - 同一ユーザーの異なるセッション間での記憶継続テスト
  - セッション内での会話文脈保持テスト
  - メモリ機能のフォールバック処理テスト
  - エラーハンドリングとログ出力の確認

- [ ] 13.4 UI側セッション管理の改善
  - 新しいチャットセッション開始機能の追加
  - セッションリセット機能の実装
  - ユーザーへのセッション状態の可視化
  - 長期記憶とセッション記憶の使い分け説明

- [ ]* 13.5 プロパティテスト: AgentCore Memory統合
  - **プロパティ 21: ユーザー長期記憶の継続性**
  - **プロパティ 22: セッション記憶の独立性**
  - **プロパティ 23: メモリ機能のフォールバック**
  - **検証対象: Actor ID = User Sub, Session ID = UI Session**

- [ ] 14. 最終チェックポイント - 全機能テスト
  - すべてのテストが通ることを確認し、ユーザに質問があれば尋ねる